{% extends "base.html" %}

{% block body %}
<style>
    .readonly {
        background-color: #e9ecef;
        pointer-events: none;
    }
</style>

<div class="container mt-4">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-4" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item display-6"><a href="/">홈</a></li>
            <li class="breadcrumb-item active display-6" aria-current="page">관리자</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-12 col-lg-3 mb-3 mb-lg-0">
            <div class="list-group" id="sidebar-nav" role="tablist">
                <a class="list-group-item list-group-item-action active" 
                   id="user-accept-tab" 
                   data-bs-toggle="list" 
                   href="#user-accept" 
                   role="tab" 
                   aria-controls="user-accept">
                    가입 승인
                </a>
                <a class="list-group-item list-group-item-action" 
                   id="user-management-tab" 
                   data-bs-toggle="list" 
                   href="#user-management" 
                   role="tab" 
                   aria-controls="user-management">
                    사용자 관리
                </a>
                <a class="list-group-item list-group-item-action" 
                    id="door-status-change-tab" 
                    data-bs-toggle="list" 
                    href="#door-status-change" 
                    role="tab" 
                    aria-controls="door-status-change">
                    문 상태 변경
                </a>
                <a class="list-group-item list-group-item-action" 
                    id="door-remote-open-tab" 
                    data-bs-toggle="list" 
                    href="#door-remote-open" 
                    role="tab" 
                    aria-controls="door-remote-open">
                    문 원격 열기
                </a>
                <a class="list-group-item list-group-item-action" 
                    id="nfc-card-management-tab" 
                    data-bs-toggle="list" 
                    href="#nfc-card-management" 
                    role="tab" 
                    aria-controls="nfc-card-management">
                    NFC 카드 관리
                </a>
                <a class="list-group-item list-group-item-action" 
                    id="guest-qr-management-tab" 
                    data-bs-toggle="list" 
                    href="#guest-qr-management" 
                    role="tab" 
                    aria-controls="guest-qr-management">
                    게스트 QR 관리
                </a>
                <a class="list-group-item list-group-item-action" 
                    id="guest-card-management-tab" 
                    data-bs-toggle="list" 
                    href="#guest-card-management" 
                    role="tab" 
                    aria-controls="guest-card-management">
                    게스트 NFC 카드 관리
                </a>
                <a class="list-group-item list-group-item-action" 
                   id="terminal-management-tab" 
                   data-bs-toggle="list" 
                   href="#terminal-management" 
                   role="tab" 
                   aria-controls="terminal-management">
                    장치 관리
                </a>
                <a class="list-group-item list-group-item-action" 
                   id="kw-bot-tab" 
                   data-bs-toggle="list" 
                   href="#kw-bot" 
                   role="tab" 
                   aria-controls="kw-bot">
                    KW 봇 설정
                </a>
                <a class="list-group-item list-group-item-action" 
                   id="logout-tab" 
                   data-bs-toggle="list" 
                   href="#logout" 
                   role="tab" 
                   aria-controls="logout">
                    로그아웃
                </a>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-12 col-lg-8">
            <div class="tab-content" id="main-content">
                {% include 'admin/tabs/user-accept.html' %}
                {% include 'admin/tabs/user_management.html' %}
                {% include 'admin/tabs/door_status_change.html' %}
                {% include 'admin/tabs/door_remote_open.html' %}
                {% include 'admin/tabs/nfc_card_management.html' %}
                {% include 'admin/tabs/guest_qr_management.html' %}
                {% include 'admin/tabs/guest_card_management.html' %}
                {% include 'admin/tabs/terminal_management.html' %}
                {% include 'admin/tabs/kw_bot_management.html' %}
                {% include 'admin/tabs/logout.html' %}
            </div>
        </div>
    </div>
</div>


<script>
const CONSTANTS = {
    SELECTORS: {
        TAB_ELEMENTS: '[data-bs-toggle="list"]',
        SIDEBAR_NAV: '#sidebar-nav',
        MAIN_CONTENT: '#main-content'
    }
};

class TabManager {
    constructor() {
        this.tabElements = document.querySelectorAll(CONSTANTS.SELECTORS.TAB_ELEMENTS);
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.handleInitialHash();
    }

    setupEventListeners() {
        window.addEventListener('hashchange', () => this.switchToTabByHash());
        
        this.tabElements.forEach(tab => {
            tab.addEventListener('click', (e) => this.handleTabClick(e));
        });
    }

    handleInitialHash() {
        if (window.location.hash) {
            this.switchToTabByHash();
        }
    }

    switchToTabByHash() {
        const hash = window.location.hash;
        if (hash) {
            const targetTab = document.querySelector(`[href="${hash}"]`);
            if (targetTab) {
                const tab = new bootstrap.Tab(targetTab);
                tab.show();
            }
        }
    }

    handleTabClick(event) {
        const href = event.target.getAttribute('href');
        if (href && href.startsWith('#')) {
            history.pushState(null, null, href);
        }
    }
}

// 사용자 검색 기능
const activeUsers = {{ active_users|default([])|tojson|safe }};

function setupOwnerSearch(inputId, uuidId, suggestionsId) {
    const searchInput = document.getElementById(inputId);
    const uuidInput = document.getElementById(uuidId);
    const suggestions = document.getElementById(suggestionsId);

    if (!searchInput || !uuidInput || !suggestions) return;

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        suggestions.innerHTML = '';

        if (!query) return;

        const filtered = activeUsers.filter(u =>
            u.name.toLowerCase().includes(query) || u.student_id.includes(query)
        );

        filtered.forEach(u => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = `${u.student_id} - ${u.name}`;
            item.addEventListener('click', () => {
                searchInput.value = `${u.student_id} - ${u.name}`;
                uuidInput.value = u.uuid;
                suggestions.innerHTML = '';
            });
            suggestions.appendChild(item);
        });
    });
}

function reloadPage(delay = 0) {
    if (delay > 0) {
        setTimeout(() => location.reload(), delay);
    } else {
        location.reload();
    }
}

// DOM 로드 완료 시 초기화
document.addEventListener('DOMContentLoaded', () => {
    new TabManager();
    
    // 사용자 검색 기능 초기화
    setupOwnerSearch('owner-search-add', 'owner-uuid-add', 'owner-suggestions-add');
    setupOwnerSearch('owner-search-edit', 'owner-uuid-edit', 'owner-suggestions-edit');
});
</script>
{% endblock %}