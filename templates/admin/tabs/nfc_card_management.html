<!-- NFC 카드 관리 탭 -->
<div class="tab-pane fade" 
    id="nfc-card-management" 
    role="tabpanel" 
    aria-labelledby="nfc-card-management-tab">
    <h3 class="h4 h-lg-3">NFC 카드 관리</h3>
    <hr>

    <!-- 카드 추가 버튼 -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#nfcAddModal">
        + NFC 카드 추가
    </button>

    <!-- 카드 목록 -->
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>별칭</th>
                    <th>상태</th>
                    <th>소유자</th>
                    <th>등록일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                {% for card in nfc_cards %}
                <tr data-card='{{ card|tojson|safe }}'>
                    <td>{{ card.name }}</td>
                    <td>
                        <span class="badge 
                            {% if card.status == 'active' %} text-bg-success 
                            {% elif card.status == 'lost' %} text-bg-warning 
                            {% elif card.status == 'stolen' %} text-bg-danger 
                            {% elif card.status == 'disabled' %} text-bg-dark {% endif %}">
                            {{ card.status }}
                        </span>
                    </td>
                    <td>{{ card.owner_name or "미지정" }}</td>
                    <td>{{ card.created_at }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="editCard({{ card|tojson|safe }})">수정</button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteCard('{{ card.id }}')">삭제</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- NFC 카드 추가 모달 -->
<div class="modal fade" id="nfcAddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="nfcAddForm">
      <div class="modal-header">
        <h5 class="modal-title">NFC 카드 등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">별칭</label>
          <input type="text" class="form-control" name="name" required>
        </div>
        <div class="mb-3">
            <label class="form-label">소유자</label>
            <input type="text" class="form-control" id="owner-search-add" placeholder="사용자 이름 검색">
            <input type="hidden" name="owner_uuid" id="owner-uuid-add">
            <div id="owner-suggestions-add" class="list-group mt-1"></div>
        </div>
        <div class="mb-3">
          <label class="form-label">상태</label>
          <select class="form-select" name="status">
            <option value="active">active</option>
            <option value="lost">lost</option>
            <option value="stolen">stolen</option>
            <option value="disabled">disabled</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="submit" class="btn btn-primary">등록</button>
      </div>
    </form>
  </div>
</div>

<!-- NFC 카드 수정 모달 -->
<div class="modal fade" id="nfcEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="nfcEditForm">
      <div class="modal-header">
        <h5 class="modal-title">NFC 카드 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id">
        <div class="mb-3">
          <label class="form-label">별칭</label>
          <input type="text" class="form-control" name="name" required>
        </div>
        <div class="mb-3">
            <label class="form-label">소유자</label>
            <input type="text" class="form-control" id="owner-search-edit" placeholder="사용자 이름 검색">
            <input type="hidden" name="owner_uuid" id="owner-uuid-edit">
            <div id="owner-suggestions-edit" class="list-group mt-1"></div>
        </div>
        <div class="mb-3">
          <label class="form-label">상태</label>
          <select class="form-select" name="status">
            <option value="active">active</option>
            <option value="lost">lost</option>
            <option value="stolen">stolen</option>
            <option value="disabled">disabled</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="submit" class="btn btn-primary">저장</button>
      </div>
    </form>
  </div>
</div>

<script>
// 수정 버튼 클릭 시
function editCard(card) {
    const form = document.getElementById("nfcEditForm");
    form.id.value = card.id;
    form.name.value = card.name;
    form.owner_uuid.value = card.owner_uuid || "";
    form.status.value = card.status;

    var myModal = new bootstrap.Modal(document.getElementById('nfcEditModal'));
    myModal.show();
}

// NFC 카드 삭제
function deleteCard(id) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    fetch("/admin/nfc/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || "삭제 완료");
        location.reload();
    })
    .catch(err => {
        console.error(err);
        alert("삭제 실패");
    });
}

// NFC 카드 추가
document.getElementById("nfcAddForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target));

    fetch("/admin/nfc/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(data => {
        alert(data.detail || "등록 완료");
        location.reload();
    })
    .catch(err => {
        console.error(err);
        alert("등록 실패");
    });
});

// NFC 카드 수정
document.getElementById("nfcEditForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target));

    fetch("/admin/nfc/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || "수정 완료");
        location.reload();
    })
    .catch(err => {
        console.error(err);
        alert("수정 실패");
    });
});
</script>
