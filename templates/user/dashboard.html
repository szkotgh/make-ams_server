{% extends "base.html" %}

{% block body %}
<div class="container mt-4">
    <div class="mb-4">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item display-6"><a href="/">홈</a></li>
                <li class="breadcrumb-item active display-6" aria-current="page">대시보드</li>
            </ol>
        </nav>
    </div>
  
    <hr>
    
    <div class="row">
        <div class="col-12 col-lg-3 mb-3 mb-lg-0">
            <div class="list-group" id="list-tab" role="tablist">
                <a class="list-group-item list-group-item-action active" id="profile-list" data-bs-toggle="list" href="#profile" role="tab" aria-controls="profile">내 정보</a>
                <a class="list-group-item list-group-item-action" id="settings-list" data-bs-toggle="list" href="#settings" role="tab" aria-controls="settings">기타 설정</a>
                <a class="list-group-item list-group-item-action" id="sessions-list" data-bs-toggle="list" href="#sessions" role="tab" aria-controls="sessions">세션 정보</a>
                <a class="list-group-item list-group-item-action" id="logout-list" data-bs-toggle="list" href="#logout" role="tab" aria-controls="logout">로그아웃</a>
            </div>
        </div>
        
        <div class="col-12 col-lg-8">
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-list">
                    <h3 class="h4 h-lg-3">내 정보</h3>
                    <hr>
                    <div class="row g-2">
                        <div class="col-12 col-sm-6">
                            <strong>아이디:</strong> {{ user_info.id }}
                        </div>
                        <div class="col-12 col-sm-6">
                            <strong>이름:</strong> {{ user_info.name }}
                        </div>
                        <div class="col-12">
                            <strong>권한:</strong> 
                            {% if is_teacher %}<span class="badge text-bg-primary">교사</span>{% else %}<span class="badge text-bg-success">학생</span>{% endif %}{% if is_admin %}<span class="badge text-bg-secondary">관리자</span>{% endif %}
                        </div>
                        <div class="col-12">
                            <strong>인적사항:</strong> 
                            {% if not is_teacher and this_year_class %}
                                {% if this_year_class.is_graduated == 0 %}{{ this_year_class.grade }}학년 {{ this_year_class.class }}반 {{ this_year_class.number }}번{% else %}졸업{% endif %}
                            {% else %}
                                올해 인적사항이 등록되지 않았습니다.
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <strong>가입일:</strong> {{ user_info.created_at }}
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-list">
                    <h3 class="h4 h-lg-3">기타 설정</h3>
                    <hr>
                    {% if kakaowork_info %}
                        <strong>카카오워크 계정:</strong> {{ kakaowork_info.kw_name }} ({{ kakaowork_info.kw_email }})
                        <button class="btn btn-danger btn-sm mt-2" onclick="unlinkKakaowork()">연결 해제</button><br><br>
                        <strong>카카오워크 알림 설정:</strong>
                        <div class="form-check form-switch">
                            <input class="form-check-input notification-toggle" type="checkbox" role="switch" 
                                   id="loginNotificationToggle" 
                                   data-type="notification_login"
                                   {% if notification_settings and notification_settings.notification_login %}checked{% endif %}>
                            <label class="form-check-label" for="loginNotificationToggle">
                                로그인 및 보안 알림
                                <span class="spinner-border spinner-border-sm d-none" id="loginSpinner" role="status"></span>
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input notification-toggle" type="checkbox" role="switch" 
                                   id="doorAccessNotificationToggle" 
                                   data-type="notification_door_access"
                                   {% if notification_settings and notification_settings.notification_door_access %}checked{% endif %}>
                            <label class="form-check-label" for="doorAccessNotificationToggle">
                                출입 발생 알림
                                <span class="spinner-border spinner-border-sm d-none" id="doorAccessSpinner" role="status"></span>
                            </label>
                        </div>
                        
                    {% else %}
                        <strong>카카오워크 계정:</strong> 연결된 카카오워크 계정이 없습니다. <button class="btn btn-primary" onclick="findKakaoworkUser()">카카오워크 계정 연결하기</button>
                    {% endif %}
                </div>
                
                <div class="tab-pane fade" id="sessions" role="tabpanel" aria-labelledby="sessions-list">
                    <h3 class="h4 h-lg-3">활성화 세션</h3>
                    <hr>
                    
                    <div class="d-none d-lg-block">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>OS</th>
                                    <th>로그인 시간</th>
                                    <th>로그아웃</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session_list_element in session_list_info %}
                                    {% if session_list_element.is_active %}
                                        <tr>
                                            <td>
                                                <div class="text-truncate" style="max-width: 300px;">{{ session_list_element.user_agent }}</div>
                                                {% if session_list_element.id == session_info.id %}<span class="badge text-bg-success">현재 세션</span>{% endif %}
                                            </td>
                                            <td>{{ session_list_element.created_at }}</td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="remoteLogout({{ loop.index0 }})">로그아웃</button>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-lg-none">
                        {% for session_list_element in session_list_info %}
                            {% if session_list_element.is_active %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <div class="text-truncate" style="max-width: 100%;">
                                                    <strong>OS:</strong> {{ session_list_element.user_agent }}
                                                </div>
                                                {% if session_list_element.id == session_info.id %}
                                                    <span class="badge text-bg-success">현재 세션</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>로그인 시간:</strong> {{ session_list_element.created_at }}
                                        </div>
                                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="remoteLogout({{ loop.index0 }})">로그아웃</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <button class="btn btn-danger w-lg-auto" onclick="logoutAll()">전체 로그아웃</button>
                </div>
                
                <div class="tab-pane fade" id="logout" role="tabpanel" aria-labelledby="logout-list">
                    <h3 class="h4 h-lg-3">로그아웃</h3>
                    <hr>
                    <button class="btn btn-danger w-100 w-lg-auto" onclick="logout()">로그아웃</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="toastTitle">알림</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
        Toast Message
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    forceRefreshNotificationToggles();
    
    const notificationToggles = document.querySelectorAll('.notification-toggle');
    
    notificationToggles.forEach((toggle, index) => {
      toggle.addEventListener('change', function() {
        updateNotificationSetting(this);
      });
    });

    const tabLinks = document.querySelectorAll('.list-group-item[data-bs-toggle="list"]');
    tabLinks.forEach(tabLink => {
      tabLink.addEventListener('click', (e) => {
        const targetId = e.target.getAttribute('href').substring(1);
        window.location.hash = targetId;
      });
    });

    const hash = window.location.hash;
    if (hash) {
      let targetTabId = '';
      let targetTabContentId = '';
      
      if (hash === '#profile') {
        targetTabId = 'profile-list';
        targetTabContentId = 'profile';
      } else if (hash === '#settings') {
        targetTabId = 'settings-list';
        targetTabContentId = 'settings';
      } else if (hash === '#sessions') {
        targetTabId = 'sessions-list';
        targetTabContentId = 'sessions';
      } else if (hash === '#logout') {
        targetTabId = 'logout-list';
        targetTabContentId = 'logout';
      }
      
      if (targetTabId && targetTabContentId) {
        const targetTab = document.getElementById(targetTabId);
        const targetTabContent = document.getElementById(targetTabContentId);
        
        if (targetTab && targetTabContent) {
          const targetTabInstance = new bootstrap.Tab(targetTab);
          targetTabInstance.show();
          
          document.querySelectorAll('.list-group-item').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('show', 'active'));
          
          targetTab.classList.add('active');
          targetTabContent.classList.add('show', 'active');
        }
      }
    }
  });

  function syncNotificationToggles() {
    const loginToggle = document.getElementById('loginNotificationToggle');
    const doorToggle = document.getElementById('doorAccessNotificationToggle');
    
    if (loginToggle && doorToggle) {
      $.ajax({
        url: '{{ url_for('router.user.settings.get_settings') }}',
        type: 'GET',
        data: { keys: ['notification_login', 'notification_door_access'] },
        cache: false,
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        },
        success: (response) => {
          if (response.code == 200) {
            const serverLoginState = Boolean(response.data['notification_login']);
            const serverDoorState = Boolean(response.data['notification_door_access']);
            
            if (loginToggle.checked !== serverLoginState) {
              loginToggle.checked = serverLoginState;
            }
            if (doorToggle.checked !== serverDoorState) {
              doorToggle.checked = serverDoorState;
            }
          }
        },
        error: (xhr, status, error) => {
          console.error(error);
        }
      });
    }
  }

  function forceRefreshNotificationToggles() {
    const loginToggle = document.getElementById('loginNotificationToggle');
    const doorToggle = document.getElementById('doorAccessNotificationToggle');
    
    if (loginToggle && doorToggle) {
      loginToggle.disabled = true;
      doorToggle.disabled = true;
      
      const originalLoginState = loginToggle.checked;
      const originalDoorState = doorToggle.checked;
      
      syncNotificationToggles();
      
      setTimeout(() => {
        loginToggle.disabled = false;
        doorToggle.disabled = false;
        
        if (loginToggle.checked !== originalLoginState && !loginToggle.disabled) {
          loginToggle.checked = originalLoginState;
        }
        if (doorToggle.checked !== originalDoorState && !doorToggle.disabled) {
          doorToggle.checked = originalDoorState;
        }
      }, 1000);
    }
  }

  function updateNotificationSetting(toggleElement) {
    // toggleElement 유효성 검사
    if (!toggleElement || !toggleElement.dataset) {
      return;
    }
    
    const notificationType = toggleElement.dataset.type;
    if (!notificationType) {
      return;
    }
    
    const isEnabled = toggleElement.checked;
    const originalState = toggleElement.checked;
    
    toggleElement.disabled = true;
    showSpinner(notificationType, true);
    
    $.ajax({
      url: '{{ url_for('router.user.notification_settings.update') }}',
      type: 'POST',
      data: { 
        type: notificationType, 
        enabled: isEnabled 
      },
      cache: false,
      success: (response) => {
        if (response.code == 200) {
          showToast('설정이 업데이트되었습니다.', 'success');
          syncNotificationToggles();
        } else {
          toggleElement.checked = originalState;
          showToast(response.message || '설정 업데이트에 실패했습니다.', 'error');
        }
      },
      error: (xhr, status, error) => {
        console.error('설정 업데이트 오류:', xhr.responseText);
        toggleElement.checked = originalState;
        showToast('서버 오류가 발생했습니다.', 'error');
        console.error('AJAX Error:', error);
      },
      complete: () => {
        toggleElement.disabled = false;
        showSpinner(notificationType, false);
      }
    });
  }

  function showSpinner(notificationType, show) {
    const spinnerId = notificationType === 'notification_login' ? 'loginSpinner' : 'doorAccessSpinner';
    const spinner = document.getElementById(spinnerId);
    if (spinner) {
      if (show) {
        spinner.classList.remove('d-none');
      } else {
        spinner.classList.add('d-none');
      }
    }
  }

  function showToast(message, type = 'info') {
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
      const toastElement = document.getElementById('notificationToast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      if (type === 'success') {
        toastTitle.textContent = '성공';
        toastTitle.className = 'me-auto text-success';
        
      } else if (type === 'error') {
        toastTitle.textContent = '오류';
        toastTitle.className = 'me-auto text-danger';
      } else {
        toastTitle.textContent = '알림';
        toastTitle.className = 'me-auto';
      }
      
      toastMessage.textContent = message;
      
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
    } else {
      if (type === 'error') {
        alert('오류: ' + message);
      } else {
        alert(message);
      }
    }
  }

  function logout() {
    if (confirm("로그아웃 하시겠습니까?")) {
      window.location.href = '{{ url_for('router.user.logout') }}';
    }
  }
  function logoutAll() {
    if (confirm("모든 세션을 로그아웃 하시겠습니까?")) {
      window.location.href = '{{ url_for('router.user.all_logout') }}';
    }
  }
  function findKakaoworkUser() {
    if (confirm("카카오워크 계정을 연결하시겠습니까?")) {
      const email = prompt("카카오워크 계정 가입 시 입력한 이메일을 입력해주세요.");
      if (!email) {
        alert("이메일을 입력해주세요.");
        return;
      }

      $.ajax({
        url: '{{ url_for('router.user.link_kakaowork.check_email') }}',
        type: 'POST',
        data: { email: email },
        success: (response) => {
          if (response.code == 200) {
            if (confirm(`카카오워크 계정을 찾았습니다.\n소속: ${response.data.department}(${response.data.responsibility || response.data.position})\n이름: ${response.data.name}\n연결하시겠습니까?`)) {
              linkKakaowork(email);
            }
          } else {
            alert(response.message);
          }
        },
        error: (xhr, status, error) => {
          console.log(xhr.responseJSON);
          alert(xhr.responseJSON.message || '처리 중 오류가 발생했습니다.');
        }
      });
    }
  }
  function linkKakaowork(email) {
    $.ajax({
      url: '{{ url_for('router.user.link_kakaowork.link_kakaowork') }}',
      type: 'POST',
      data: { email: email },
      success: (response) => {
        if (response.code == 200) {
          alert("카카오워크 계정을 연결했습니다.");
        } else {
          alert(response.message);
        }
        window.location.reload();
      },
      error: (xhr, status, error) => {
          console.log(xhr.responseJSON);
          alert(xhr.responseJSON.message || '처리 중 오류가 발생했습니다.');
      }
    });
  }

  function unlinkKakaowork() {
    if (confirm("카카오워크 계정 연결을 해제하시겠습니까?\n\n연결 해제 시:\n- 카카오워크 알림이 더 이상 발송되지 않습니다\n- 카카오워크 관련 기능 이용이 불가합니다.")) {
      $.ajax({
        url: '{{ url_for('router.user.link_kakaowork.unlink_kakaowork') }}',
        type: 'DELETE',
        success: (response) => {
          if (response.code == 200) {
            alert("카카오워크 계정 연결이 해제되었습니다.");
          } else {
            alert(response.message);
          }
          window.location.reload();
        },
        error: (xhr, status, error) => {
          console.log(xhr.responseJSON);
          alert(xhr.responseJSON.message || '처리 중 오류가 발생했습니다.');
        }
      });
    }
  }

  function activateTab(tabId, contentId) {
    const targetTab = document.getElementById(tabId);
    const targetTabContent = document.getElementById(contentId);
    
    if (targetTab && targetTabContent) {
      const targetTabInstance = new bootstrap.Tab(targetTab);
      targetTabInstance.show();
      
      document.querySelectorAll('.list-group-item').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('show', 'active'));
      
      targetTab.classList.add('active');
      targetTabContent.classList.add('show', 'active');
    }
  }

  function remoteLogout(sessionIndex) {
    if (confirm("이 세션을 로그아웃 하시겠습니까?")) {
      $.ajax({
        url: '{{ url_for('router.user.remote_logout') }}',
        type: 'POST',
        data: { index: sessionIndex },
        success: (response) => {
          if (response.code == 200) {
            showToast(response.message, 'success');
          } else {
            showToast(response.message, 'error');
          }
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        },
        error: (xhr, status, error) => {
          showToast('서버 오류가 발생했습니다.', 'error');
          console.error('AJAX Error:', error);
        }
      });
    }
  }
</script>
{% endblock %}