{% extends 'base.html' %}

{% block body %}
    <div class="container mt-4">
        <h1>MAKE; AMS</h1>
        <hr>
        <div class="text-center">
            <h2>MAKE; AMS</h2>
            <p>
                메이크 출입 관리 시스템입니다.<br>
                메이크 출입 시 해당 시스템으로 인증하셔야 합니다.
            </p>
        </div>
        <hr>
        <div class="text-center">
            <p>아래 버튼을 눌러 앱을 설치하세요.</p>
            <button id="installBtn" class="btn btn-primary btn-lg px-5" onclick="install()">앱 설치</button>
        </div>
        <hr>
        <div class="text-center">
            <p>IOS는 아래 이미지를 참고해 설정해주세요.</p>
            <img src="{{ url_for('static', filename='images/pwa_ios.png') }}" alt="IOS PWA 설치 방법" class="img-fluid">
        </div>
        <hr>
        <div class="text-center mb-5">
            <button id="skipBtn" class="btn btn-secondary btn-lg px-5" onclick="skip()">웹으로 계속하기</button>
        </div>
    </div>

    <script>
        let deferredPrompt;

        function checkPWAInstallation() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.matchMedia('(display-mode: fullscreen)').matches) {
                document.cookie = "skip_welcome=True; path=/";
                window.location.reload();
            }
        }

        window.addEventListener('load', checkPWAInstallation);

        window.matchMedia('(display-mode: standalone)').addEventListener('change', checkPWAInstallation);
        window.matchMedia('(display-mode: fullscreen)').addEventListener('change', checkPWAInstallation);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        async function install() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            } else {
                alert('앱을 설치할 수 없는 환경입니다.\nChrome 브라우저를 이용해보세요.');
            }
        }

        function skip() {
            if (confirm('정말 웹으로 계속하시겠습니까?')) {
                if (confirm('왠만하면 앱 설치가 좋을텐데요?')) {
                    if (confirm('정말 웹으로..?')) {
                        document.cookie = "skip_welcome=True; path=/";
                        window.location.reload();
                    }
                }
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then((registration) => {
                    console.log('Service Worker 등록 성공:', registration);
                })
                .catch((error) => {
                    console.log('Service Worker 등록 실패:', error);
                });
        }
    </script>
{% endblock body %}