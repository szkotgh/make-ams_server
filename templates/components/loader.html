<style>
  #global-loader {
    pointer-events: none;
    opacity: 0;
    position: fixed;
    z-index: 99999;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(30,30,30,0.4);
    backdrop-filter: blur(6px);
    transition: opacity 0.5s ease-in-out;
  }

  .loader-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .spinner-rotate {
    animation: spin 1s linear infinite;
    transform-origin: center;
  }

  .spinner-rotate.fast {
    animation-duration: 0.4s !important;
  }


  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<div id="global-loader" aria-hidden="true">
  <div class="loader-spinner" role="status" aria-live="polite">
    <svg width="60" height="60" viewBox="0 0 50 50">
      <g class="spinner-rotate">
        <circle cx="25" cy="25" r="20" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4" stroke-dashoffset="0"/>
      </g>
    </svg>
  </div>
</div>

<script>
  (function () {
    const SELECTOR = '#global-loader';
    let __loaderCount = 0;
    let __hideTimer = null;

    function getElems() {
      const loader = document.querySelector(SELECTOR);
      const spinner = loader ? loader.querySelector('.spinner-rotate') : null;
      return { loader, spinner };
    }

    function showLoader() {
      const { loader, spinner } = getElems();
      if (!loader) return;
      if (__hideTimer) {
        clearTimeout(__hideTimer);
        __hideTimer = null;
      }
      __loaderCount++;
      spinner && spinner.classList.remove('fast');
      loader.style.pointerEvents = 'all';
      loader.style.opacity = '1';
      loader.setAttribute('aria-hidden', 'false');
    }

    function hideLoader(force) {
      const { loader, spinner } = getElems();
      if (!loader) return;
      if (force) __loaderCount = 0;
      else if (__loaderCount > 0) __loaderCount--;

      if (__loaderCount > 0) return;

      spinner && spinner.classList.add('fast');

      if (__hideTimer) clearTimeout(__hideTimer);
      __hideTimer = setTimeout(() => {
        loader.style.opacity = '0';
        const onEnd = (e) => {
          if (e && e.propertyName !== 'opacity') return;
          loader.style.pointerEvents = 'none';
          loader.setAttribute('aria-hidden', 'true');
          loader.removeEventListener('transitionend', onEnd);
        };
        loader.addEventListener('transitionend', onEnd);
        setTimeout(() => {
          loader.style.pointerEvents = 'none';
          loader.setAttribute('aria-hidden', 'true');
        }, 700);
        __hideTimer = null;
      }, 100);
    }

    window.showLoader = showLoader;
    window.hideLoader = hideLoader;
    window.showGlobalLoader = showLoader;
    window.hideGlobalLoader = hideLoader;

    document.addEventListener('DOMContentLoaded', () => {
      hideLoader(true);
    });
  })();
</script>
